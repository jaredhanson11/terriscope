<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Territories Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
      .info {
        position: absolute;
        top: 10px;
        left: 10px;
        background: #fff;
        padding: 8px 12px;
        font-family: system-ui;
        font-size: 14px;
        border-radius: 4px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
      }
      .info b {
        display: block;
        margin-bottom: 4px;
      }
      .nav-links {
        position: absolute;
        top: 10px;
        left: 10px;
        display: flex;
        gap: 8px;
        z-index: 10;
      }
      .nav-link {
        background: #fff;
        padding: 8px 12px;
        font-family: system-ui;
        font-size: 13px;
        border-radius: 4px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        text-decoration: none;
        color: #007bff;
        font-weight: 500;
        transition: all 0.15s;
      }
      .nav-link:hover {
        background: #007bff;
        color: #fff;
      }
      .nav-link.active {
        background: #e9ecef;
        color: #333;
        cursor: default;
      }
      .controls {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #fff;
        padding: 12px;
        font-family: system-ui;
        font-size: 14px;
        border-radius: 4px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
      }
      .controls label {
        display: block;
        margin-bottom: 8px;
        cursor: pointer;
      }
      .controls input[type="radio"] {
        margin-right: 6px;
      }
      .controls .section {
        margin-top: 16px;
        padding-top: 12px;
        border-top: 1px solid #ddd;
      }
      .controls .section:first-child {
        margin-top: 0;
        padding-top: 0;
        border-top: none;
      }
      .sidebar {
        position: absolute;
        left: 10px;
        top: 120px;
        bottom: 10px;
        width: 300px;
        background: #fff;
        border-radius: 4px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        overflow-y: auto;
        font-family: system-ui;
        font-size: 13px;
      }
      .sidebar-header {
        padding: 12px;
        border-bottom: 1px solid #ddd;
        font-weight: bold;
        position: sticky;
        top: 0;
        background: #fff;
        z-index: 1;
      }
      .layer-item {
        border-bottom: 1px solid #eee;
      }
      .layer-header {
        padding: 10px 12px;
        background: #f8f9fa;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .layer-header:hover {
        background: #e9ecef;
      }
      .layer-header.active {
        background: #e3f2fd;
      }
      .layer-actions {
        display: flex;
        gap: 4px;
      }
      .btn-sm {
        padding: 2px 8px;
        font-size: 11px;
        border: 1px solid #ccc;
        background: #fff;
        border-radius: 3px;
        cursor: pointer;
      }
      .btn-sm:hover {
        background: #f0f0f0;
      }
      .node-list {
        display: none;
        max-height: 200px;
        overflow-y: auto;
      }
      .node-list.show {
        display: block;
      }
      .node-item {
        padding: 6px 12px 6px 24px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
      }
      .node-item:hover {
        background: #f8f9fa;
      }
      .node-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
        border: 1px solid #ccc;
        display: inline-block;
        margin-right: 6px;
      }
      .add-layer-form {
        padding: 12px;
        border-bottom: 1px solid #ddd;
        background: #f8f9fa;
      }
      .add-layer-form input {
        width: calc(100% - 60px);
        padding: 4px 8px;
        border: 1px solid #ccc;
        border-radius: 3px;
        font-size: 12px;
      }
      .add-layer-form button {
        padding: 4px 12px;
        margin-left: 4px;
        border: 1px solid #007bff;
        background: #007bff;
        color: #fff;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
      }
      .add-layer-form button:hover {
        background: #0056b3;
      }
      .add-node-form {
        padding: 8px 12px;
        background: #f0f8ff;
        border-top: 1px solid #ddd;
        display: none;
      }
      .add-node-form.show {
        display: block;
      }
      .add-node-form input {
        width: 120px;
        padding: 3px 6px;
        border: 1px solid #ccc;
        border-radius: 3px;
        font-size: 11px;
        margin-right: 4px;
      }
      .add-node-form button {
        padding: 3px 10px;
        border: 1px solid #28a745;
        background: #28a745;
        color: #fff;
        border-radius: 3px;
        cursor: pointer;
        font-size: 11px;
      }
      .add-node-form button:hover {
        background: #218838;
      }
    </style>
  </head>
  <body>
    <div class="nav-links">
      <a href="/static/index.html" class="nav-link active">Map</a>
      <a href="/static/hierarchy.html" class="nav-link">Hierarchy</a>
      <a href="/static/explorer.html" class="nav-link">Explorer</a>
    </div>
    <div id="map"></div>
    <div class="info">
      <b>Atom Layers Demo</b>
      <div>Status: <span id="status">Initializing...</span></div>
      <div>Zoom: <span id="zoom">-</span></div>
    </div>
    <div class="sidebar">
      <div class="sidebar-header">Layer & Node Manager</div>
      <div class="add-layer-form">
        <input
          type="text"
          id="new-layer-name"
          placeholder="New layer name..."
        />
        <button onclick="createLayer()">Add</button>
      </div>
      <div id="layers-container"></div>
    </div>
    <div class="controls">
      <div class="section">
        <b>Base Map</b>
        <label>
          <input
            type="radio"
            name="basemap"
            value="osm"
            onchange="switchBasemap('osm')"
            checked
          />
          OpenStreetMap
        </label>
        <label>
          <input
            type="radio"
            name="basemap"
            value="positron"
            onchange="switchBasemap('positron')"
          />
          Light (Positron)
        </label>
        <label>
          <input
            type="radio"
            name="basemap"
            value="satellite"
            onchange="switchBasemap('satellite')"
          />
          Satellite
        </label>
        <label>
          <input
            type="radio"
            name="basemap"
            value="terrain"
            onchange="switchBasemap('terrain')"
          />
          Terrain
        </label>
      </div>
    </div>
    <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
    <script>
      const statusEl = document.getElementById("status");
      const zoomEl = document.getElementById("zoom");
      const layersContainer = document.getElementById("layers-container");

      let layers = [];
      let currentLayerId = null;
      const layerSources = new Map();

      // API functions
      async function fetchLayers() {
        const response = await fetch(`${window.location.origin}/layers`);
        layers = await response.json();
        layers.sort((a, b) => b.order - a.order); // Reverse order for display
        renderLayers();
      }

      async function fetchNodes(layerId) {
        const response = await fetch(
          `${window.location.origin}/nodes?layer_id=${layerId}`
        );
        return await response.json();
      }

      async function createLayer() {
        const input = document.getElementById("new-layer-name");
        const name = input.value.trim();
        if (!name) return;

        try {
          const maxOrder = Math.max(...layers.map((l) => l.order), -1);
          const response = await fetch(`${window.location.origin}/layers`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              name,
              order: maxOrder + 1,
              parent_layer_id: null,
            }),
          });
          if (response.ok) {
            input.value = "";
            await fetchLayers();
            statusEl.textContent = `Layer "${name}" created`;
          }
        } catch (error) {
          console.error("Error creating layer:", error);
          statusEl.textContent = "Error creating layer";
        }
      }

      function toggleAddNode(layerId) {
        const form = document.getElementById(`add-node-form-${layerId}`);
        form.classList.toggle("show");
      }

      async function createNode(layerId) {
        const nameInput = document.getElementById(`node-name-${layerId}`);
        const colorInput = document.getElementById(`node-color-${layerId}`);
        const name = nameInput.value.trim();
        const color = colorInput.value;

        if (!name) {
          statusEl.textContent = "Node name required";
          return;
        }

        try {
          // Get the default node from the parent layer
          const layer = layers.find((l) => l.id === layerId);
          if (!layer || layer.order === 0) {
            statusEl.textContent = "Cannot create nodes in layer 0";
            return;
          }

          const parentLayer = layers.find((l) => l.order === layer.order - 1);
          if (!parentLayer) {
            statusEl.textContent = "Parent layer not found";
            return;
          }

          // Fetch nodes from parent layer to get default node
          const parentNodes = await fetchNodes(parentLayer.id);
          const defaultNode = parentNodes.find((n) => n.name === "__default__");

          if (!defaultNode) {
            statusEl.textContent = "Parent default node not found";
            return;
          }

          const response = await fetch(`${window.location.origin}/nodes`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              layer_id: layerId,
              parent_node_id: defaultNode.id,
              name,
              color,
            }),
          });

          if (response.ok) {
            nameInput.value = "";
            colorInput.value = "#3388ff";
            toggleAddNode(layerId);
            // Refresh nodes if they're visible
            const nodeList = document.getElementById(`nodes-${layerId}`);
            if (nodeList.classList.contains("show")) {
              const nodes = await fetchNodes(layerId);
              renderNodes(layerId, nodes);
            }
            statusEl.textContent = `Node "${name}" created`;
          } else {
            const error = await response.json();
            statusEl.textContent = `Error: ${
              error.detail || "Failed to create node"
            }`;
          }
        } catch (error) {
          console.error("Error creating node:", error);
          statusEl.textContent = "Error creating node";
        }
      }

      async function toggleNodes(layerId) {
        const nodeList = document.getElementById(`nodes-${layerId}`);
        const isVisible = nodeList.classList.contains("show");

        if (isVisible) {
          nodeList.classList.remove("show");
        } else {
          nodeList.innerHTML =
            '<div style="padding: 8px; color: #666;">Loading...</div>';
          nodeList.classList.add("show");

          try {
            const nodes = await fetchNodes(layerId);
            renderNodes(layerId, nodes);
          } catch (error) {
            nodeList.innerHTML =
              '<div style="padding: 8px; color: #d32f2f;">Error loading nodes</div>';
          }
        }
      }

      function renderNodes(layerId, nodes) {
        const nodeList = document.getElementById(`nodes-${layerId}`);

        if (nodes.length === 0) {
          nodeList.innerHTML =
            '<div style="padding: 8px; color: #666; font-style: italic;">No nodes in this layer</div>';
          return;
        }

        nodeList.innerHTML = nodes
          .map(
            (node) => `
          <div class="node-item" draggable="true" data-node-id="${node.id}">
            <div>
              <span class="node-color" style="background-color: ${
                node.color || "#ccc"
              }"></span>
              <span>${node.name}</span>
            </div>
            <div class="layer-actions">
              <button class="btn-sm" onclick="editNode(${
                node.id
              })">Edit</button>
              <button class="btn-sm" onclick="viewNode(${
                node.id
              })">View</button>
            </div>
          </div>
        `
          )
          .join("");
      }

      function renderLayers() {
        layersContainer.innerHTML = layers
          .map(
            (layer) => `
          <div class="layer-item">
            <div class="layer-header" onclick="selectLayer(${
              layer.id
            })" id="layer-header-${layer.id}">
              <div>
                <strong>Layer ${layer.order}: ${layer.name}</strong>
                <small style="display: block; color: #666; margin-top: 2px;">
                  ${layer.node_count || 0} nodes
                </small>
              </div>
              <div class="layer-actions" onclick="event.stopPropagation()">
                ${
                  layer.order > 0
                    ? `<button class="btn-sm" onclick="toggleAddNode(${layer.id})">+</button>`
                    : ""
                }
                <button class="btn-sm" onclick="toggleNodes(${
                  layer.id
                })">▼</button>
                <label style="margin: 0 4px; display: inline-flex; align-items: center; cursor: pointer; font-size: 11px;" title="Show as colored fill">
                  <input type="radio" name="fill-layer" value="${
                    layer.id
                  }" onchange="setFillLayer(${
              layer.id
            })" style="margin: 0 3px 0 0;" />
                  Fill
                </label>
                <label style="margin: 0 4px; display: inline-flex; align-items: center; cursor: pointer; font-size: 11px;" title="Show outline">
                  <input type="checkbox" class="outline-checkbox" data-layer-id="${
                    layer.id
                  }" onchange="toggleOutline(${
              layer.id
            }, this.checked)" style="margin: 0 3px 0 0;" />
                  Border
                </label>
                <label style="margin: 0; display: inline-flex; align-items: center; cursor: pointer; font-size: 11px;" title="Show labels">
                  <input type="radio" name="label-layer" value="${
                    layer.id
                  }" onchange="setLabelLayer(${
              layer.id
            })" style="margin: 0 3px 0 0;" />
                  Labels
                </label>
              </div>
            </div>
            ${
              layer.order > 0
                ? `
            <div class="add-node-form" id="add-node-form-${layer.id}">
              <input type="text" id="node-name-${layer.id}" placeholder="Node name..." />
              <input type="color" id="node-color-${layer.id}" value="#3388ff" />
              <button onclick="createNode(${layer.id})">Add</button>
            </div>
            `
                : ""
            }
            <div class="node-list" id="nodes-${layer.id}"></div>
          </div>
        `
          )
          .join("");
      }

      function selectLayer(layerId) {
        document
          .querySelectorAll(".layer-header")
          .forEach((el) => el.classList.remove("active"));
        document
          .getElementById(`layer-header-${layerId}`)
          .classList.add("active");
        currentLayerId = layerId;
      }

      function setFillLayer(layerId) {
        // Hide all fill layers
        layerSources.forEach((_, id) => {
          if (map.getLayer(`layer${id}-fill`)) {
            map.setLayoutProperty(`layer${id}-fill`, "visibility", "none");
          }
        });

        // Add layer to map if not already added
        if (!layerSources.has(layerId)) {
          addLayerToMap(layerId);
        }

        // Show selected fill layer
        if (map.getLayer(`layer${layerId}-fill`)) {
          map.setLayoutProperty(
            `layer${layerId}-fill`,
            "visibility",
            "visible"
          );
        }

        selectLayer(layerId);
        statusEl.textContent = `Fill: Layer ${layerId}`;
      }

      function toggleOutline(layerId, show) {
        // Add layer to map if not already added
        if (!layerSources.has(layerId)) {
          addLayerToMap(layerId);
        }

        // Toggle outline visibility
        if (map.getLayer(`layer${layerId}-outline`)) {
          map.setLayoutProperty(
            `layer${layerId}-outline`,
            "visibility",
            show ? "visible" : "none"
          );
        }

        const action = show ? "shown" : "hidden";
        statusEl.textContent = `Border for Layer ${layerId} ${action}`;
      }

      function setLabelLayer(layerId) {
        // Hide all label layers
        layerSources.forEach((_, id) => {
          if (map.getLayer(`layer${id}-label`)) {
            map.setLayoutProperty(`layer${id}-label`, "visibility", "none");
          }
        });

        // Add layer to map if not already added
        if (!layerSources.has(layerId)) {
          addLayerToMap(layerId);
        }

        // Show selected label layer
        if (map.getLayer(`layer${layerId}-label`)) {
          map.setLayoutProperty(
            `layer${layerId}-label`,
            "visibility",
            "visible"
          );
        }

        statusEl.textContent = `Labels: Layer ${layerId}`;
      }

      function addLayerToMap(layerId) {
        if (layerSources.has(layerId)) return;

        map.addSource(`layer${layerId}`, {
          type: "vector",
          tiles: [`${window.location.origin}/tiles/${layerId}/{z}/{x}/{y}.pbf`],
          minzoom: 0,
          maxzoom: 22,
        });

        map.addLayer({
          id: `layer${layerId}-fill`,
          type: "fill",
          source: `layer${layerId}`,
          "source-layer": "nodes",
          paint: {
            "fill-color": ["coalesce", ["get", "color"], "#ff00ff"],
            "fill-opacity": 0.6,
          },
          layout: {
            visibility: "none",
          },
        });

        map.addLayer({
          id: `layer${layerId}-outline`,
          type: "line",
          source: `layer${layerId}`,
          "source-layer": "nodes",
          paint: {
            "line-color": "#333",
            "line-width": 1,
          },
          layout: {
            visibility: "none",
          },
        });

        map.addLayer({
          id: `layer${layerId}-label`,
          type: "symbol",
          source: `layer${layerId}`,
          "source-layer": "nodes",
          layout: {
            "text-field": ["get", "name"],
            "text-size": 12,
            "text-anchor": "center",
            visibility: "none",
          },
          paint: {
            "text-color": "#000",
            "text-halo-color": "#fff",
            "text-halo-width": 2,
          },
        });

        layerSources.set(layerId, true);
      }

      function editNode(nodeId) {
        console.log("Edit node:", nodeId);
        // TODO: Implement node editing
        statusEl.textContent = `Editing node ${nodeId}`;
      }

      function viewNode(nodeId) {
        console.log("View node:", nodeId);
        // TODO: Implement zoom to node
        statusEl.textContent = `Viewing node ${nodeId}`;
      }

      // Initialize map centered roughly on continental US
      const map = new maplibregl.Map({
        container: "map",
        style: {
          version: 8,
          glyphs: "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
          sources: {},
          layers: [],
        },
        center: [-98.5795, 39.8283],
        minZoom: 4,
        zoom: 4,
        maxZoom: 14,
      });

      // Update zoom level display
      function updateZoom() {
        zoomEl.textContent = map.getZoom().toFixed(2);
      }

      map.on("zoom", updateZoom);
      map.on("zoomend", updateZoom);

      // Basemap sources configuration
      const basemaps = {
        osm: {
          type: "raster",
          tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
          tileSize: 256,
          attribution: "© OpenStreetMap",
        },
        positron: {
          type: "raster",
          tiles: ["https://basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png"],
          tileSize: 256,
          attribution: "© CARTO",
        },
        satellite: {
          type: "raster",
          tiles: [
            "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
          ],
          tileSize: 256,
          attribution: "© Esri",
        },
        terrain: {
          type: "raster",
          tiles: ["https://tile.opentopomap.org/{z}/{x}/{y}.png"],
          tileSize: 256,
          attribution: "© OpenTopoMap",
        },
      };

      function switchBasemap(basemapId) {
        // Hide all basemap layers
        Object.keys(basemaps).forEach((id) => {
          if (map.getLayer(`basemap-${id}`)) {
            map.setLayoutProperty(`basemap-${id}`, "visibility", "none");
          }
        });

        // Show selected basemap
        if (map.getLayer(`basemap-${basemapId}`)) {
          map.setLayoutProperty(
            `basemap-${basemapId}`,
            "visibility",
            "visible"
          );
        }

        statusEl.textContent = `Basemap: ${basemapId}`;
      }

      map.on("load", async () => {
        updateZoom();

        // Add all basemap sources and layers
        Object.entries(basemaps).forEach(([id, config]) => {
          map.addSource(`basemap-${id}`, config);

          map.addLayer({
            id: `basemap-${id}`,
            type: "raster",
            source: `basemap-${id}`,
            layout: {
              visibility: id === "osm" ? "visible" : "none",
            },
          });
        });

        statusEl.textContent = "Loading tiles...";

        // Load layers from API
        await fetchLayers();
        statusEl.textContent = "Layers loaded";

        // Simple feature inspect on click
        map.on("click", (e) => {
          // Build list of all fill layers that are visible
          const fillLayers = layers
            .filter((layer) => {
              const layerObj = map.getLayer(`layer${layer.id}-fill`);
              return (
                layerObj &&
                map.getLayoutProperty(`layer${layer.id}-fill`, "visibility") ===
                  "visible"
              );
            })
            .map((layer) => `layer${layer.id}-fill`);

          if (!fillLayers.length) return;

          const features = map.queryRenderedFeatures(e.point, {
            layers: fillLayers,
          });
          if (!features.length) return;
          const f = features[0];

          // Extract layer ID from the layer name (e.g., "layer1-fill" -> 1)
          const layerIdMatch = f.layer.id.match(/layer(\d+)-fill/);
          const clickedLayerId = layerIdMatch
            ? parseInt(layerIdMatch[1])
            : null;
          const clickedLayer = layers.find((l) => l.id === clickedLayerId);
          const layerName = clickedLayer
            ? `${clickedLayer.name} (Layer ${clickedLayer.order})`
            : "Unknown Layer";

          new maplibregl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(
              `<strong>${layerName}</strong><br><span style="color: ${
                f.properties.color || "#333"
              };">●</span> ${f.properties.name || "Unnamed"}`
            )
            .addTo(map);
        });

        // Debug: log feature count after first color application
        setTimeout(() => {
          try {
            const layer1Feats = map.querySourceFeatures("layer1", {
              sourceLayer: "nodes",
            });
            const layer2Feats = map.querySourceFeatures("layer2", {
              sourceLayer: "nodes",
            });
            const layer3Feats = map.querySourceFeatures("layer3", {
              sourceLayer: "nodes",
            });
            console.log("Layer 1 features loaded:", layer1Feats.length);
            console.log("Layer 2 features loaded:", layer2Feats.length);
            console.log("Layer 3 features loaded:", layer3Feats.length);
            if (
              !layer1Feats.length &&
              !layer2Feats.length &&
              !layer3Feats.length
            ) {
              console.warn(
                "No features visible. Check MVT layer names or tile responses."
              );
            }
          } catch (e) {
            console.warn("Feature query failed:", e);
          }
        }, 2000);
      });
    </script>
  </body>
</html>
